---
import { Image } from 'astro:assets';

export interface Props {
  src: any;
  alt: string;
  class?: string;
  dialogId?: string;
}

const { src, alt, class: className = '', dialogId = 'lightbox' } = Astro.props as Props;
---

<Image id={`thumb-${dialogId}`} src={src} alt={alt} class={`cursor-zoom-in ${className}`} />

<dialog id={dialogId} class="p-0 bg-transparent">
  <div class="lb-content">
    <button type="button" aria-label="Close image" class="lb-close absolute top-4 right-4 text-white/90 text-2xl leading-none">Ã—</button>
    <img src={src.src} alt={alt} class="max-w-[90vw] max-h-[85vh] rounded-xl shadow-2xl" />
  </div>
</dialog>

<style>
  dialog::backdrop { background-color: rgba(0, 0, 0, 0.6); }
  dialog { border: none; padding: 0; background: transparent; }
  dialog[open] { inset: 0; margin: auto; display: grid; place-items: center; }

  .lb-content { position: relative; opacity: 1; transform: scale(1); transition: transform 180ms ease, opacity 180ms ease; }
  dialog.opening .lb-content { opacity: 0; transform: scale(0.95); }
  dialog.closing .lb-content { opacity: 0; transform: scale(0.95); }

  :where(img) { display: block; }
  :where(button) { cursor: pointer; }

</style>

<script define:vars={{dialogId}}>
  document.addEventListener('DOMContentLoaded', () => {
    const DIALOG_ID = dialogId;
    const dialog = document.getElementById(DIALOG_ID);
    const thumb = document.getElementById(`thumb-${DIALOG_ID}`);
    
    if (!dialog || !thumb || !(dialog instanceof HTMLDialogElement)) return;
    const closeBtn = dialog.querySelector('button');
    const content = dialog.querySelector('.lb-content');

    const animateOpen = () => {
      dialog.classList.remove('closing');
      dialog.classList.add('opening');
      dialog.showModal();
      // Force a frame so the opening styles apply before transitioning to final state
      requestAnimationFrame(() => {
        dialog.classList.remove('opening');
      });
    };

    const animateClose = () => {
      if (dialog.classList.contains('closing')) return;
      dialog.classList.add('closing');
      const onEnd = () => {
        dialog.removeEventListener('transitionend', onEnd);
        dialog.close();
        dialog.classList.remove('closing');
      };
      if (content) {
        content.addEventListener('transitionend', onEnd, { once: true });
      } else {
        setTimeout(onEnd, 200);
      }
    };

    thumb.addEventListener('click', animateOpen);
    dialog.addEventListener('click', (event) => {
      if (event.target === dialog) animateClose();
    });
    dialog.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && dialog.open) {
        event.preventDefault();
        animateClose();
      }
    });
    dialog.addEventListener('cancel', (event) => {
      event.preventDefault();
      animateClose();
    });
    closeBtn && closeBtn.addEventListener('click', animateClose);
  });
</script>


